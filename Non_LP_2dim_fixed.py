#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Sat Nov 16 10:24:56 2019

@author: tahereh
"""

#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Tue Oct 22 17:31:13 2019

@author: tahereh
"""

import pandas as pd
import numpy as np
import time
import math
from scipy.optimize import minimize
from numdifftools import Jacobian, Hessian
from scipy.stats import entropy

def objective(x):
    function = 0 
    ### pittsburgh census 
    function = x[0] * (0.48 * 0.23) + x[1] * (0.48 * 0.16) + x[2] * (0.48 * 0.09) + x[3] * (0.48 * 0.11) + x[4] * (0.48 * 0.12) + x[5] * (0.48 * 0.09) + x[6] * (0.52 * 0.23) + x[7] * (0.52 * 0.16) + x[8] * (0.52 * 0.09) + x[9] * (0.52 * 0.11) + x[10] * (0.52 * 0.12) + x[11] * (0.52 * 0.09) + x[12] * (0 * 0.23) + x[13] * (0 * 0.16) + x[14] * (0 * 0.09) + x[15] * (0 * 0.11) + x[16] * (0 * 0.12) + x[17] * (0 * 0.09) + x[18] * (0.48 * 0.2) + x[19] * (0.52 * 0.2) + x[20] * (0 * 0.2)
    function = function / math.sqrt((x[0]**2 + x[1]**2 + x[2]**2 + x[3]**2 + x[4]**2 + x[5]**2 + x[6]**2 + x[7]**2 + x[8]**2 + x[9]**2 + x[10]**2 + x[11]**2 + x[12]**2 + x[13]**2 + x[14]**2 + x[15]**2 + x[16]**2 + x[17]**2 + x[18]**2 + x[19]**2 + x[20]**2) 
    * ((0.48 * 0.23)**2 + (0.48 * 0.16)**2 + (0.48 * 0.09)**2 + (0.48 * 0.11)**2 + (0.48 * 0.12)**2 + (0.48 * 0.09)**2 + (0.52 * 0.23)**2 + (0.52 * 0.16)**2 + (0.52 * 0.09)**2 + (0.52 * 0.11)**2 + (0.52 * 0.12)**2 + (0.52 * 0.09)**2 + (0 * 0.23)**2 + (0 * 0.16)**2 + (0 * 0.09)**2 + (0 * 0.11)**2 + (0 * 0.12)**2 + (0 * 0.09)**2 + (0.48 * 0.2)**2 + (0.52 * 0.2)**2 + (0 * 0.2)**2))
    function = 1 - function
    

  ##############################
    #New York
    """
    function = x[0] * (0.48 * 0.16) + x[1] * (0.48 * 0.16) + x[2] * (0.48 * 0.13) + x[3] * (0.48 * 0.12) + x[4] * (0.48 * 0.10) + x[5] * (0.48 * 0.10) + x[6] * (0.52 * 0.16) + x[7] * (0.52 * 0.16) + x[8] * (0.52 * 0.13) + x[9] * (0.52 * 0.12) + x[10] * (0.52 * 0.10) + x[11] * (0.52 * 0.10) + x[12] * (0 * 0.16) + x[13] * (0 * 0.16) + x[14] * (0 * 0.13) + x[15] * (0 * 0.12) + x[16] * (0 * 0.10) + x[17] * (0 * 0.10) + x[18] * (0.48 * 0.23) + x[19] * (0.52 * 0.23) + x[20] * (0 * 0.23)
    function = function / math.sqrt((x[0]**2 + x[1]**2 + x[2]**2 + x[3]**2 + x[4]**2 + x[5]**2 + x[6]**2 + x[7]**2 + x[8]**2 + x[9]**2 + x[10]**2 + x[11]**2 + x[12]**2 + x[13]**2 + x[14]**2 + x[15]**2 + x[16]**2 + x[17]**2 + x[18]**2 + x[19]**2 + x[20]**2) 
    * ((0.48 * 0.16)**2 + (0.48 * 0.16)**2 + (0.48 * 0.13)**2 + (0.48 * 0.12)**2 + (0.48 * 0.10)**2 + (0.48 * 0.10)**2 + (0.52 * 0.16)**2 + (0.52 * 0.16)**2 + (0.52 * 0.13)**2 + (0.52 * 0.12)**2 + (0.52 * 0.10)**2 + (0.52 * 0.10)**2 + (0 * 0.16)**2 + (0 * 0.16)**2 + (0 * 0.13)**2 + (0 * 0.12)**2 + (0 * 0.10)**2 + (0 * 0.10)**2 + (0.48 * 0.23)**2 + (0.52 * 0.23)**2 + (0 * 0.23)**2))
    function = 1 - function
    """
    ##############################
    ### Florida Census
    """
    function = x[0] * (0.49 * 0.13) + x[1] * (0.49 * 0.13) + x[2] * (0.49 * 0.12) + x[3] * (0.49 * 0.13) + x[4] * (0.49 * 0.13) + x[5] * (0.49 * 0.13) + x[6] * (0.51 * 0.13) + x[7] * (0.51 * 0.13) + x[8] * (0.51 * 0.12) + x[9] * (0.51 * 0.13) + x[10] * (0.51 * 0.13) + x[11] * (0.51 * 0.13) + x[12] * (0 * 0.13) + x[13] * (0 * 0.13) + x[14] * (0 * 0.12) + x[15] * (0 * 0.13) + x[16] * (0 * 0.13) + x[17] * (0 * 0.13) + x[18] * (0.49 * 0.23) + x[19] * (0.51 * 0.23) + x[20] * (0 * 0.23)
    function = function / math.sqrt((x[0]**2 + x[1]**2 + x[2]**2 + x[3]**2 + x[4]**2 + x[5]**2 + x[6]**2 + x[7]**2 + x[8]**2 + x[9]**2 + x[10]**2 + x[11]**2 + x[12]**2 + x[13]**2 + x[14]**2 + x[15]**2 + x[16]**2 + x[17]**2 + x[18]**2 + x[19]**2 + x[20]**2) 
    * ((0.49 * 0.13)**2 + (0.49 * 0.13)**2 + (0.49 * 0.12)**2 + (0.49 * 0.13)**2 + (0.49 * 0.13)**2 + (0.49 * 0.13)**2 + (0.51 * 0.13)**2 + (0.51 * 0.13)**2 + (0.51 * 0.12)**2 + (0.51 * 0.13)**2 + (0.51 * 0.13)**2 + (0.51 * 0.13)**2 + (0 * 0.13)**2 + (0 * 0.13)**2 + (0 * 0.12)**2 + (0 * 0.13)**2 + (0 * 0.13)**2 + (0 * 0.13)**2 + (0.49 * 0.23)**2 + (0.51 * 0.23)**2 + (0 * 0.23)**2))
    function = 1 - function
    """
    ##############################
    #college Park
    """
    function = x[0] * (0.53 * 0.35) + x[1] * (0.53 * 0.08) + x[2] * (0.53 * 0.07) + x[3] * (0.53 * 0.08) + x[4] * (0.53 * 0.04) + x[5] * (0.53 * 0.03) + x[6] * (0.47 * 0.35) + x[7] * (0.47 * 0.08) + x[8] * (0.47 * 0.07) + x[9] * (0.47 * 0.08) + x[10] * (0.47 * 0.04) + x[11] * (0.47 * 0.03) + x[12] * (0 * 0.35) + x[13] * (0 * 0.08) + x[14] * (0 * 0.07) + x[15] * (0 * 0.08) + x[16] * (0 * 0.04) + x[17] * (0 * 0.03) + x[18] * (0.53 * 0.35) + x[19] * (0.47 * 0.35) + x[20] * (0 * 0.35)
    function = function / math.sqrt((x[0]**2 + x[1]**2 + x[2]**2 + x[3]**2 + x[4]**2 + x[5]**2 + x[6]**2 + x[7]**2 + x[8]**2 + x[9]**2 + x[10]**2 + x[11]**2 + x[12]**2 + x[13]**2 + x[14]**2 + x[15]**2 + x[16]**2 + x[17]**2 + x[18]**2 + x[19]**2 + x[20]**2) 
    * ((0.53 * 0.35)**2 + (0.53 * 0.08)**2 + (0.53 * 0.07)**2 + (0.53 * 0.08)**2 + (0.53 * 0.04)**2 + (0.53 * 0.03)**2 + (0.47 * 0.35)**2 + (0.47 * 0.08)**2 + (0.47 * 0.07)**2 + (0.47 * 0.08)**2 + (0.47 * 0.04)**2 + (0.47 * 0.03)**2 + (0 * 0.35)**2 + (0 * 0.08)**2 + (0 * 0.07)**2 + (0 * 0.08)**2 + (0 * 0.04)**2 + (0 * 0.03)**2 + (0.53 * 0.35)**2 + (0.47 * 0.35)**2 + (0 * 0.35)**2))
    function = 1 - function
    """
    return function
    
def constraint(x):
    sum_eq = 1.0
    for i in range(0,21):
        sum_eq = sum_eq - x[i]   
    return sum_eq
    
 
def shannonEntropy(final):
    pk = []
    for f in final:
        pk.append(f/100)
        
    ent = entropy(pk)
    return ent       
    
def kl_divergence():
    p =[]
    q = []
    diversity_rules = pd.read_csv('PSL_diversity_rules.csv', sep=",") 
    final = diversity_rules['final_percentage']
    ideal =  diversity_rules['joint_ideal_percentage']
    
    for f in final:
        p.append(f/100)
        
    for i in ideal:
        q.append(i/100)    
    
    
    kl = 0
    for i in range(len(p)):
        if p[i] != 0:
            kl = kl +  (p[i] * np.log(p[i]/q[i]))
    return round(kl,3)        
    #OR
    """
    p = np.asarray(p, dtype=np.float)
    q = np.asarray(q, dtype=np.float)
    return round(np.sum(np.where(p != 0, p * np.log(p / q), 0)),3)
    """

    
if __name__ == "__main__": 
    
    start_time = time.time()
    initial = [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0000001,0.0,0.0,0.0,0.0
               ,0.0,0.0,0.0,0.0,0.0,0.0,0.0]
    #---------------
    #bounds
    Nout = 100
    bx1= (0,16/Nout)
    bx2= (0, 21/Nout)
    bx3= (0, 42/Nout)
    bx4= (0, 55/Nout)
    bx5= (0, 83/Nout)
    bx6= (0 , 49/Nout)
    bx7= (0, 35/Nout)
    bx8= (0, 72/Nout)
    bx9= (0, 109/Nout)
    bx10= (0, 151/Nout)
    bx11= (0, 179/Nout)
    bx12= (0, 63/Nout)
    bx13= (0,0)
    bx14= (0,0)
    bx15= (0,0)
    bx16= (0,0)
    bx17= (0,0)
    bx18= (0,0)
    bx19= (0,3/Nout)
    bx20= (0,4/Nout)
    bx21= (0,0)
    bnds = (bx1, bx2, bx3, bx4, bx5 , bx6, bx7, bx8, 
            bx9, bx10, bx11, bx12, bx13, bx14, bx15, bx16, bx17, bx18, 
            bx19, bx20, bx21)
    #---------------
    con42 = {'type': 'eq', 'fun': constraint}
    cons = ([con42]) 
    #---------------
    solution = minimize(objective,initial,method='SLSQP', jac = None, hess= None, bounds=bnds,constraints=cons, options={'disp':True})
    x = solution.x
    #---------------
    # show final objective
    print('Final SSE Objective: ' + str(objective(x)))
    print("--- %s seconds ---" % (time.time() - start_time))
    # print solution
    print('Solution')
    for i in range(0,21):
        print('x' , i ,  ' = ' + str(round(x[i],5)))
    
    #entro = shannonEntropy(x)
    #print('entropy = ', entro)
    
    kld = kl_divergence()
    print('kl divergence is == ', kld)


